# MKV 文件添加问题调试指南

## 问题
MKV 文件无法添加到压缩队列

## 已实施的修复
✅ 修复了 ArrayBuffer 序列化问题（使用数字数组）  
✅ 添加了详细的日志输出  
✅ 文件类型过滤已支持 MKV（通过扩展名匹配）

## 调试步骤

### 1. 打开浏览器控制台查看错误
在 Electron 应用中：
- 右键点击应用窗口，选择"检查元素"
- 或按 `Cmd+Option+I` (Mac) 或 `Ctrl+Shift+I` (Windows/Linux)
- 切换到 "Console"（控制台）标签

### 2. 尝试添加 MKV 文件
拖拽或选择 `test.mkv` 文件

### 3. 查看控制台输出
你应该会看到类似这样的日志：
```
📁 收到文件: 1 个文件
📄 处理文件: test.mkv 类型: (空或application/octet-stream) 大小: XXX
💾 保存文件到临时目录...
✅ 临时文件已保存: /var/.../test_xxx.mkv
🔍 开始探测文件信息...
```

### 4. 检查错误消息
如果有错误，你会看到：
```
❌ 文件探测失败: test.mkv Error: ...
错误详情: ...
错误堆栈: ...
```

## 常见问题和解决方案

### 问题 A: 文件没有被过滤（显示"不支持的格式"）
**原因**: 文件类型检测失败

**检查点**:
1. 确认文件名以 `.mkv` 结尾
2. 查看控制台的 `📄 处理文件:` 日志，检查文件是否被处理

**解决方法**:
MKV 文件在 Electron 中可能没有正确的 MIME type，我们依赖扩展名匹配。如果文件名匹配，应该能通过。

### 问题 B: 临时文件保存失败
**原因**: IPC 通信或权限问题

**检查点**:
1. 查看是否有 `✅ 临时文件已保存:` 日志
2. 检查临时目录权限

**解决方法**:
确认应用有写入 `/tmp/ffmpeg-app-temp` 的权限

### 问题 C: FFmpeg 探测失败
**原因**: FFmpeg/FFprobe 无法读取 MKV 文件

**检查点**:
1. 查看错误消息中是否有 FFmpeg/FFprobe 的退出码
2. 运行 `ffprobe test.mkv` 检查文件是否有效

**解决方法**:
```bash
# 测试文件是否有效
ffprobe test.mkv

# 如果返回错误，文件可能已损坏
```

### 问题 D: 文件太大导致内存问题
**原因**: 大文件导致 ArrayBuffer 转换失败

**检查点**:
1. 查看文件大小
2. 如果文件 > 1GB，可能需要在主进程中直接读取

**解决方法**:
使用较小的测试文件（< 100MB）确认问题

## 快速测试命令

在终端运行以下命令检查文件：

```bash
# 1. 检查文件是否存在
ls -lh test.mkv

# 2. 测试 ffprobe 能否读取文件
ffprobe test.mkv

# 3. 获取文件信息
ffprobe -v error -show_format -show_streams test.mkv

# 4. 检查文件类型
file test.mkv
```

## 最新状态

应用已添加详细日志：
- ✅ 文件接收日志
- ✅ 临时文件保存日志  
- ✅ FFmpeg 探测日志
- ✅ 错误详情和堆栈

请重新尝试添加 MKV 文件，并查看控制台输出，然后将错误信息发送给我。
